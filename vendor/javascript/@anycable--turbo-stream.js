// @anycable/turbo-stream@0.8.1 downloaded from https://ga.jspm.io/npm:@anycable/turbo-stream@0.8.1/index.js

import{Channel as e}from"@anycable/core";import{connectStreamSource as t,disconnectStreamSource as s}from"@hotwired/turbo";class TurboChannel extends e{static identifier="__turbo__";constructor(e,t,s){super(s);this.element=e;this.channelId=t}set channelId(e){this._channelId=e}get channelId(){return this._channelId}}function walk(e){return e&&typeof e==="object"?e instanceof Date||e instanceof RegExp?e:Array.isArray(e)?e.map(walk):Object.keys(e).reduce(((t,s)=>{let n=s[0].toLowerCase()+s.slice(1).replace(/([A-Z]+)/g,((e,t)=>"_"+t.toLowerCase()));t[n]=walk(e[s]);return t}),{}):e}function isPreview(){return document.documentElement.hasAttribute("data-turbo-preview")}class TurboStreamSourceElement extends HTMLElement{static cable;static channelClass;static delayedUnsubscribe;async connectedCallback(){t(this);if(isPreview())return;let e=this.constructor.cable;let s=this.constructor.channelClass;let n=this.getAttribute("channel");let i=this.getAttribute("signed-stream-name");let r=walk({...this.dataset});this.listeners=[];this.channel=new s(this,n,{signed_stream_name:i,...r});this.listeners.push(this.channel.on("connect",(()=>this.setAttribute("connected",""))));this.listeners.push(this.channel.on("disconnect",(()=>this.removeAttribute("connected"))));this.listeners.push(this.channel.on("message",this.dispatchMessageEvent.bind(this)));e.subscribe(this.channel)}disconnectedCallback(){s(this);if(this.channel){for(let e of this.listeners)e();this.listeners.length=0;let e=this.channel;let t=this.constructor.delayedUnsubscribe;t?setTimeout((()=>e.disconnect()),t):e.disconnect()}}dispatchMessageEvent(e){let t=new MessageEvent("message",{data:e});return this.dispatchEvent(t)}}class TurboPresenceSourceElement extends HTMLElement{static cable;static delayedUnsubscribe;async connectedCallback(){t(this);if(isPreview())return;let e=this.constructor.cable;let s=this.getAttribute("signed-stream-name");this.presenceId=this.getAttribute("presence-id");if(!this.presenceId)throw new Error("Presence source must have a presence-id attribute");this.joinTemplate=this.querySelector("template");if(!this.joinTemplate)throw new Error("No join action template defined");this.ignoreSelf=this.hasAttribute("ignore-self");this.presenceInitialized=false;this.listeners=[];this.channel=e.streamFromSigned(s);this.listeners.push(this.channel.on("connect",(()=>{this.setAttribute("connected","");this.initializePresence()})));this.listeners.push(this.channel.on("disconnect",(()=>this.removeAttribute("connected"))));this.listeners.push(this.channel.on("presence",this.handlePresenceEvent.bind(this)))}disconnectedCallback(){s(this);if(this.channel){for(let e of this.listeners)e();this.listeners.length=0;let e=this.channel;let t=this.constructor.delayedUnsubscribe||500;t?setTimeout((()=>e.disconnect()),t):e.disconnect()}}async initializePresence(){let e=document.createElement("div");e.appendChild(this.joinTemplate.content.cloneNode(true));let t=e.innerHTML.trim();this.channel.presence.join(this.presenceId,{html:t});await this.invalidatePresence();let s=await this.channel.presence.info();this.presenceInitialized=true;for(let e in s)this.handlePresenceEvent({type:"join",id:e,info:{html:s[e].html}})}async invalidatePresence(){let e=await this.channel.presence.info();this.ignoreSelf&&delete e[this.presenceId];this.updateCounter(Object.keys(e).length)}handlePresenceEvent(e){if(this.presenceInitialized&&(!this.ignoreSelf||e.id!==this.presenceId)){if(e.type==="join"){let t=new MessageEvent("message",{data:e.info.html});this.dispatchEvent(t)}if(e.type==="leave"){let t=document.getElementById(e.id);t&&t.remove()}this.invalidatePresence()}}updateCounter(e){e?this.setAttribute("present",""):this.removeAttribute("present");let t=this.querySelector("[data-presence-counter]");t&&(t.textContent=e)}}const n="X-Socket-ID";function start(e,t={}){let s=t.tagName||"turbo-cable-stream-source";let i=t.channelClass||TurboChannel;let r=t.delayedUnsubscribe||0;let c=t.presence||false;let a=t.presenceTagName||"turbo-cable-presence-source";r===true&&(r=300);let l=class extends TurboStreamSourceElement{};l.cable=e;l.channelClass=i;l.delayedUnsubscribe=r;customElements.get(s)===void 0&&customElements.define(s,l);if(c){let t=class extends TurboPresenceSourceElement{};t.cable=e;t.delayedUnsubscribe=r;customElements.get(a)===void 0&&customElements.define(a,t)}if(t.requestSocketIDHeader){let s=t.requestSocketIDHeader===true?n:t.requestSocketIDHeader;document.addEventListener("turbo:before-fetch-request",(t=>{e.sessionId&&!t.detail.fetchOptions.headers[s]&&(t.detail.fetchOptions.headers[s]=e.sessionId)}))}}export{n as DEFAULT_SOCKET_HEADER,TurboChannel,start};

